generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String                @id @default(uuid())
  username                String                @unique
  passwordHash            String
  email                   String                @unique
  fullName                String
  isActive                Boolean               @default(true)
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  mediaFiles              MediaFile[]
  posts                   Post[]
  roles                   UserRole[]
  chatRoomParticipants    ChatRoomParticipant[]
  sentMessages            Message[]
  messageReactions        MessageReaction[]
  presence                UserPresence?
  createdChatRooms        ChatRoom[]            @relation("CreatedChatRooms")
  hostedVideoSessions     VideoSession[]
  videoParticipations     VideoParticipant[]

  @@map("users")
}

model Permission {
  id          String           @id @default(uuid())
  name        String           @unique
  description String?
  createdAt   DateTime         @default(now())
  roles       RolePermission[]

  @@map("permissions")
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  permissions RolePermission[]
  users       UserRole[]

  @@map("roles")
}

model RolePermission {
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model UserRole {
  userId     String
  roleId     String
  assignedAt DateTime @default(now())
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model Category {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  posts       Post[]

  @@map("categories")
}

model Post {
  id            String      @id @default(uuid())
  title         String
  slug          String      @unique
  content       String
  categoryId    String?
  status        PostStatus
  authorId      String?
  publishedAt   DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  excerpt       String?
  featuredImage String?
  author        User?       @relation(fields: [authorId], references: [id])
  category      Category?   @relation(fields: [categoryId], references: [id])
  embedding     Unsupported("vector(768)")?
  chunks        PostChunk[]

  @@map("posts")
}

model PostChunk {
  id        String                      @id @default(uuid())
  postId    String
  content   String
  chunkIndex Int
  embedding Unsupported("vector(768)")?
  createdAt DateTime                    @default(now())
  post      Post                        @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, chunkIndex])
  @@map("post_chunks")
}

model MediaFile {
  id           String   @id @default(uuid())
  filename     String
  originalName String
  mimeType     String
  sizeBytes    Int
  storagePath  String
  uploadedBy   String?
  createdAt    DateTime @default(now())
  uploader     User?    @relation(fields: [uploadedBy], references: [id])

  @@map("media_files")
}

model FAQ {
  id           String   @id @default(uuid())
  question     String
  answer       String
  displayOrder Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("faqs")
}

model Major {
  id                  String         @id @default(uuid())
  code                String         @unique
  name                String
  subjectCombinations Json
  description         String?
  isActive            Boolean        @default(true)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  applications        Application[]
  quotas              SessionQuota[]

  @@map("majors")
}

model AdmissionSession {
  id           String         @id @default(uuid())
  name         String
  year         Int
  startDate    DateTime
  endDate      DateTime
  status       SessionStatus
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  applications Application[]
  quotas       SessionQuota[]
  students     Student[]

  @@map("admission_sessions")
}

model SessionQuota {
  id              String           @id @default(uuid())
  sessionId       String
  majorId         String
  admissionMethod String
  quota           Int
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  conditions      Json?
  major           Major            @relation(fields: [majorId], references: [id], onDelete: Cascade)
  session         AdmissionSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, majorId, admissionMethod])
  @@map("session_quotas")
}

model Student {
  id             String              @id @default(uuid())
  idCard         String              @unique
  fullName       String
  dateOfBirth    DateTime
  email          String?
  phone          String?
  address        String?
  priorityPoints Decimal             @default(0) @db.Decimal(5, 2)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  documentPdf    String?
  idCardPhoto    String?
  photo3x4       String?
  scores         Json?
  sessionId      String
  applications   Application[]
  notifications  EmailNotification[]
  session        AdmissionSession    @relation(fields: [sessionId], references: [id])

  @@map("students")
}

model Application {
  id                 String           @id @default(uuid())
  studentId          String
  sessionId          String
  majorId            String
  admissionMethod    String
  preferencePriority Int
  subjectScores      Json
  calculatedScore    Decimal?         @db.Decimal(6, 2)
  rankInMajor        Int?
  admissionStatus    AdmissionStatus
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  major              Major            @relation(fields: [majorId], references: [id])
  session            AdmissionSession @relation(fields: [sessionId], references: [id])
  student            Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, sessionId, preferencePriority])
  @@map("applications")
}

model EmailNotification {
  id           String      @id @default(uuid())
  studentId    String
  email        String
  templateName String
  templateData Json
  status       EmailStatus
  attempts     Int         @default(0)
  sentAt       DateTime?
  lastError    String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  student      Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("email_notifications")
}

model Settings {
  key         String   @id
  value       Json
  description String?
  updatedAt   DateTime @updatedAt

  @@map("settings")
}

enum PostStatus {
  draft
  published
}

enum SessionStatus {
  upcoming
  active
  closed
}

enum AdmissionStatus {
  pending
  admitted
  not_admitted
}

enum EmailStatus {
  pending
  processing
  sent
  failed
}

model ChatRoom {
  id           String                @id @default(uuid())
  name         String?
  type         RoomType              @default(DIRECT)
  isPublic     Boolean               @default(false)
  description  String?
  createdBy    String?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  participants ChatRoomParticipant[]
  messages     Message[]
  creator      User?                 @relation("CreatedChatRooms", fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([isPublic, type])
  @@map("chat_rooms")
}

model ChatRoomParticipant {
  id         String    @id @default(uuid())
  roomId     String
  userId     String
  role       String    @default("MEMBER") // ADMIN, MEMBER
  joinedAt   DateTime  @default(now())
  lastReadAt DateTime?
  room       ChatRoom  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId])
  @@map("chat_room_participants")
}

model Message {
  id        String            @id @default(uuid())
  roomId    String
  senderId  String
  content   String
  type      MessageType       @default(TEXT)
  isPinned  Boolean           @default(false)
  metadata  Json?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  deletedAt DateTime?
  room      ChatRoom          @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender    User              @relation(fields: [senderId], references: [id])
  reactions MessageReaction[]

  @@index([roomId, createdAt])
  @@map("messages")
}

model MessageReaction {
  id        String   @id @default(uuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@map("message_reactions")
}

model UserPresence {
  userId   String   @id
  status   String   @default("offline")
  lastSeen DateTime @default(now())
  socketId String?
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_presence")
}

model VideoSession {
  id           String             @id @default(uuid())
  roomId       String             @unique
  title        String
  hostId       String
  status       VideoSessionStatus @default(SCHEDULED)
  startedAt    DateTime?
  endedAt      DateTime?
  createdAt    DateTime           @default(now())
  host         User               @relation(fields: [hostId], references: [id])
  participants VideoParticipant[]

  @@map("video_sessions")
}

model VideoParticipant {
  id        String       @id @default(uuid())
  sessionId String
  userId    String
  joinedAt  DateTime     @default(now())
  leftAt    DateTime?
  duration  Int?
  session   VideoSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id])

  @@map("video_participants")
}

enum RoomType {
  DIRECT
  GROUP
  CHANNEL
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

enum VideoSessionStatus {
  SCHEDULED
  ACTIVE
  ENDED
}
